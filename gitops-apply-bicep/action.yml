name: 'Apply Bicep configuration'
description: 'Create or update the Azure infrastructure using Bicep'
inputs:
  azure_credentials:
    description: 'Azure Credentials, stored in a secret on your GitHub repository, generated by https://github.com/microsoft/NubesGen/blob/main/docs/gitops-quick-start.md'
    required: true
  project_name: 
    description: 'Name of the current project. Required for generating deployment names'
    required: true
  deployment_region: 
    description: 'Target Azure Region for deployment'
    required: true  
outputs: 
  application_name:
    description: 'Name of the application'
    value:     
  application_url: 
    description: 'URL of the application'
    value:     
  resource_group: 
    description: 'Resource group name where the resources has been deployed'
    value:     
  container_registry_name: 
    description: 'The Container registry name that have been deployed'
    value:    
  spring_cloud_service_name: 
    description: 'Azure Spring Cloud service name'
    value:           
runs:
  using: "composite"
  steps:
    - name: Checkout code
      uses: actions/checkout@v2
    - name: Set environment variables
      env:
        AZURE_CREDENTIALS: ${{ inputs.azure_credentials }}
      run: |
        TAG_NAME=${GITHUB_REF#refs/*/}
        echo "ENVIRONMENT=${TAG_NAME:4}" >> $GITHUB_ENV
        echo "ARM_CLIENT_ID=$(echo $AZURE_CREDENTIALS | jq -r .clientId)" >> $GITHUB_ENV
        echo "ARM_SUBSCRIPTION_ID=$(echo $AZURE_CREDENTIALS | jq -r .subscriptionId)" >> $GITHUB_ENV
        echo "ARM_TENANT_ID=$(echo $AZURE_CREDENTIALS | jq -r .tenantId)" >> $GITHUB_ENV
      shell: bash
    - name: Log into Azure
      uses: azure/login@v1
      with:
        creds: ${{ inputs.azure_credentials }}
    - name: Deploy infrastructure
      uses: azure/arm-deploy@v1
      with:
        template: '${{ github.workspace }}/bicep/main.bicep'
        scope: subscription
        deploymentName: 'nubesgen-${{ inputs.project_name }}-${{env.ENVIRONMENT}}'
        region: '${{ inputs.deployment_region }}'